---
# tasks related to Nextcloud initial config for ansible-role-nextcloud-docker.

- name: Check Nextcloud trusted domains and set them.
  nextcloud_occ_config:
    key: "trusted_domains"
    value_array: "{{ nd_nextcloud_trusted_domains }}"
    executable: "{{ nd_nextcloud_occ_prefix }} php occ"

- name: Enable system encryption.
  when: nd_nextcloud_encryption_enabled
  block:
    - name: Check encryption status.
      shell: "{{ nd_nextcloud_occ_prefix }} php occ encryption:status"
      register: nd_nextcloud_encryption_status
      changed_when: false

    - name: Enable encryption.
      shell: "{{ nd_nextcloud_occ_prefix }} php occ encryption:enable"
      when: "'enabled: false' in nd_nextcloud_encryption_status.stdout"

- name: Enable encryption module.
  when: nd_nextcloud_encryption_enabled
  block:
    - name: Check if module is already installed.
      shell: "{{ nd_nextcloud_occ_prefix }} php occ app:list --output=json"
      register: nd_nextcloud_raw_app_list
      changed_when: false

    - name: Store app list.
      set_fact:
        nd_nextcloud_app_list: "{{ nd_nextcloud_raw_app_list.stdout }}"

    - name: Install encryption module.
      shell: "{{ nd_nextcloud_occ_prefix }} php occ app:enable {{ nd_nextcloud_encryption_module }}"
      when: "nd_nextcloud_encryption_module in nd_nextcloud_app_list.disabled"

- name: Set additional Nextcloud configuration parameters
  block:

  - name: Configure additional Nextcloud settings.
    nextcloud_occ_config:
      state: present
      executable: "{{ nd_nextcloud_occ_prefix }} php occ"
      key: "{{ item.key }}"
      value_string: "{{ item.string_value | default(omit)  }}"
      value_array: "{{ item.array_value | default(omit)  }}"
    loop: "{{ nd_nexcloud_additional_configuration }}"
    when: "nd_nexcloud_additional_configuration is defined"
